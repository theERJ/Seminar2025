<!DOCTYPE html>
<html>
<head>
  <title>Mixed Reality Gallery</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Verified A-Frame and A-Frame Extras scripts -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #arButton {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
    }
    #rawArButton {
      position: fixed;
      bottom: 60px;
      left: 20px;
      padding: 10px 20px;
      background-color: #ff4500;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
    }
    #debugLog {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      max-width: 50%;
      max-height: 50%;
      overflow-y: auto;
      z-index: 1000;
      font-family: monospace;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <a-scene id="scene" renderer="alpha: true" background="color: transparent">
    <!-- Camera rig for VR navigation -->
    <a-entity id="rig" movement-controls="speed: 0.2">
      <a-entity camera position="0 1.6 0" look-controls></a-entity>
      <!-- Controllers for Quest 3 -->
      <a-entity id="left-hand" hand-controls="hand: left"></a-entity>
      <a-entity id="right-hand" hand-controls="hand: right" teleport-controls="cameraRig: #rig; landingNormal: 0 1 0"></a-entity>
    </a-entity>

    <!-- 3D Objects with gaze interaction -->
    <a-box position="-2 1 -3" scale="0.5 0.5 0.5" color="red" animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
           gaze-interaction data-original-color="red" data-gaze-color="green"></a-box>
    <a-sphere position="0 1 -3" radius="0.5" color="blue" animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
              gaze-interaction data-original-color="blue" data-gaze-color="purple"></a-sphere>
    <a-torus position="2 1 -3" radius="0.3" radius-tubular="0.1" color="yellow" animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
             gaze-interaction data-original-color="yellow" data-gaze-color="orange"></a-torus>

    <!-- Simple text for context -->
    <a-text value="MR Gallery Demo" align="center" position="0 2 -2" color="black" scale="1 1 1"></a-text>
  </a-scene>

  <!-- Buttons to start AR session -->
  <button id="arButton">Enter AR Mode (A-Frame)</button>
  <button id="rawArButton">Enter AR Mode (Raw WebXR)</button>

  <!-- Debug log display -->
  <div id="debugLog"></div>

  <!-- Custom scripts -->
  <script>
    // Debug logging function
    const debugLog = document.getElementById('debugLog');
    function log(message) {
      debugLog.innerHTML += message + '<br>';
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    // Gaze interaction component
    AFRAME.registerComponent('gaze-interaction', {
      init: function () {
        this.el.addEventListener('mouseenter', () => {
          const gazeColor = this.el.getAttribute('data-gaze-color');
          this.el.setAttribute('color', gazeColor);
        });
        this.el.addEventListener('mouseleave', () => {
          const originalColor = this.el.getAttribute('data-original-color');
          this.el.setAttribute('color', originalColor);
        });
      }
    });

    // Manual AR session handling
    document.addEventListener('DOMContentLoaded', () => {
      const arButton = document.getElementById('arButton');
      const rawArButton = document.getElementById('rawArButton');
      const sceneEl = document.getElementById('scene');
      const scene = sceneEl.sceneEl; // A-Frame scene object

      log('Checking WebXR support...');
      if (!navigator.xr) {
        log('WebXR not supported in this browser.');
        arButton.textContent = 'WebXR Not Supported';
        arButton.disabled = true;
        rawArButton.textContent = 'WebXR Not Supported';
        rawArButton.disabled = true;
        return;
      }

      // Check if immersive-ar is supported
      navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
        if (supported) {
          log('immersive-ar is supported.');
          arButton.style.display = 'block';
          rawArButton.style.display = 'block';

          // A-Frame AR session
          arButton.addEventListener('click', () => {
            log('Requesting immersive-ar session (A-Frame)...');
            navigator.xr.requestSession('immersive-ar').then((session) => {
              log('immersive-ar session started successfully (A-Frame).');
              scene.enterAR(session);
              setTimeout(() => {
                log('Passthrough should be active now (A-Frame).');
                arButton.style.display = 'none';
                rawArButton.style.display = 'none';
              }, 2000);
            }).catch((err) => {
              log('Failed to start AR session (A-Frame): ' + err.message);
              alert('Failed to start AR mode (A-Frame). Falling back to VR.');
              startVRSession();
            });
          });

          // Raw WebXR AR session
          rawArButton.addEventListener('click', () => {
            log('Requesting immersive-ar session (Raw WebXR)...');
            navigator.xr.requestSession('immersive-ar').then(async (session) => {
              log('immersive-ar session started successfully (Raw WebXR).');
              const canvas = sceneEl.querySelector('canvas');
              const gl = canvas.getContext('webgl', { xrCompatible: true });

              // Bind the WebXR session to the WebGL context
              session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

              // Start the session rendering loop
              let animationFrameId;
              const renderLoop = () => {
                session.requestAnimationFrame((time, frame) => {
                  const pose = frame.getViewerPose(frame.getSession().renderState.baseSpace);
                  if (pose) {
                    gl.bindFramebuffer(gl.FRAMEBUFFER, session.renderState.baseLayer.framebuffer);
                    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                    // A-Frame will handle rendering the scene
                    scene.renderer.render(scene.object3D, scene.camera);
                  }
                  animationFrameId = session.requestAnimationFrame(renderLoop);
                });
              };
              renderLoop();

              // Hide buttons
              setTimeout(() => {
                log('Passthrough should be active now (Raw WebXR).');
                arButton.style.display = 'none';
                rawArButton.style.display = 'none';
              }, 2000);
            }).catch((err) => {
              log('Failed to start AR session (Raw WebXR): ' + err.message);
              alert('Failed to start AR mode (Raw WebXR). Falling back to VR.');
              startVRSession();
            });
          });
        } else {
          log('immersive-ar not supported, falling back to VR.');
          arButton.textContent = 'Enter VR Mode';
          rawArButton.style.display = 'none';
          arButton.addEventListener('click', startVRSession);
        }
      }).catch((err) => {
        log('Error checking immersive-ar support: ' + err.message);
        arButton.textContent = 'WebXR Error';
        arButton.disabled = true;
        rawArButton.textContent = 'WebXR Error';
        rawArButton.disabled = true;
      });

      function startVRSession() {
        log('Requesting immersive-vr session...');
        navigator.xr.requestSession('immersive-vr').then((session) => {
          log('immersive-vr session started successfully.');
          scene.enterVR(session);
          const sky = document.createElement('a-sky');
          sky.setAttribute('color', '#87CEEB');
          sceneEl.appendChild(sky);
          arButton.style.display = 'none';
          rawArButton.style.display = 'none';
        }).catch((err) => {
          log('Failed to start VR session: ' + err.message);
          alert('Failed to start VR mode.');
        });
      }
    });
  </script>
</body>
</html>
