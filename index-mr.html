<!DOCTYPE html>
<html>
<head>
  <title>Mixed Reality Gallery</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Verified A-Frame and A-Frame Extras scripts -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-extras@7.5.0/dist/aframe-extras.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #arButton {
      position: fixed;
      bottom: 20px;
      left: 20px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
    }
    #debugLog {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      max-width: 50%;
      max-height: 50%;
      overflow-y: auto;
      z-index: 1000;
      font-family: monospace;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <a-scene id="scene" renderer="alpha: true" background="color: transparent">
    <!-- Camera rig for VR navigation -->
    <a-entity id="rig" movement-controls="speed: 0.2">
      <a-entity camera position="0 1.6 0" look-controls></a-entity>
      <!-- Controllers for Quest 3 -->
      <a-entity id="left-hand" hand-controls="hand: left"></a-entity>
      <a-entity id="right-hand" hand-controls="hand: right" teleport-controls="cameraRig: #rig; landingNormal: 0 1 0"></a-entity>
    </a-entity>

    <!-- 3D Objects with gaze interaction -->
    <a-box position="-2 1 -3" scale="0.5 0.5 0.5" color="red" animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
           gaze-interaction data-original-color="red" data-gaze-color="green"></a-box>
    <a-sphere position="0 1 -3" radius="0.5" color="blue" animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
              gaze-interaction data-original-color="blue" data-gaze-color="purple"></a-sphere>
    <a-torus position="2 1 -3" radius="0.3" radius-tubular="0.1" color="yellow" animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
             gaze-interaction data-original-color="yellow" data-gaze-color="orange"></a-torus>

    <!-- Simple text for context -->
    <a-text value="MR Gallery Demo" align="center" position="0 2 -2" color="black" scale="1 1 1"></a-text>
  </a-scene>

  <!-- Button to manually start AR session -->
  <button id="arButton">Enter AR Mode</button>

  <!-- Debug log display -->
  <div id="debugLog"></div>

  <!-- Custom scripts -->
  <script>
    // Debug logging function
    const debugLog = document.getElementById('debugLog');
    function log(message) {
      debugLog.innerHTML += message + '<br>';
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    // Gaze interaction component
    AFRAME.registerComponent('gaze-interaction', {
      init: function () {
        this.el.addEventListener('mouseenter', () => {
          const gazeColor = this.el.getAttribute('data-gaze-color');
          this.el.setAttribute('color', gazeColor);
        });
        this.el.addEventListener('mouseleave', () => {
          const originalColor = this.el.getAttribute('data-original-color');
          this.el.setAttribute('color', originalColor);
        });
      }
    });

    // Manual AR session handling
    document.addEventListener('DOMContentLoaded', () => {
      const arButton = document.getElementById('arButton');
      const scene = document.getElementById('scene');

      log('Checking WebXR support...');
      if (!navigator.xr) {
        log('WebXR not supported in this browser.');
        arButton.textContent = 'WebXR Not Supported';
        arButton.disabled = true;
        return;
      }

      // Check if immersive-ar is supported
      navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
        if (supported) {
          log('immersive-ar is supported.');
          arButton.style.display = 'block';
          arButton.addEventListener('click', () => {
            log('Requesting immersive-ar session...');
            navigator.xr.requestSession('immersive-ar').then((session) => {
              log('immersive-ar session started successfully.');
              scene.setAttribute('xr-session', session);
              arButton.style.display = 'none'; // Hide button after entering AR
            }).catch((err) => {
              log('Failed to start AR session: ' + err.message);
              alert('Failed to start AR mode. Falling back to VR.');
              startVRSession();
            });
          });
        } else {
          log('immersive-ar not supported, falling back to VR.');
          arButton.textContent = 'Enter VR Mode';
          arButton.addEventListener('click', startVRSession);
        }
      }).catch((err) => {
        log('Error checking immersive-ar support: ' + err.message);
        arButton.textContent = 'WebXR Error';
        arButton.disabled = true;
      });

      function startVRSession() {
        log('Requesting immersive-vr session...');
        navigator.xr.requestSession('immersive-vr').then((session) => {
          log('immersive-vr session started successfully.');
          scene.setAttribute('xr-session', session);
          // Add a sky for VR mode since passthrough won't work
          const sky = document.createElement('a-sky');
          sky.setAttribute('color', '#87CEEB');
          scene.appendChild(sky);
          arButton.style.display = 'none';
        }).catch((err) => {
          log('Failed to start VR session: ' + err.message);
          alert('Failed to start VR mode.');
        });
      }
    });
  </script>
</body>
</html>
